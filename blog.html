<!DOCTYPE html>
<html lang="en" class="no-js">

<style>
    .carousel-caption-blur {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 10px;
        padding: 1rem;
    }

    .navbar-light .navbar-nav .open>.nav-link,
    .navbar-light .navbar-nav .active>.nav-link,
    .navbar-light .navbar-nav .nav-link.open,
    .navbar-light .navbar-nav .nav-link.active {
        clip-path: none !important;
        border-bottom: 1px solid #CCC;
    }

    .fc-toolbar-title {
        text-transform: uppercase;
    }

    /* Modal */
    .modal-header {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        padding: 1rem 3rem;
    }

    .modal-title {
        margin: 0;
        text-align: center;
        flex: 1;
        word-break: break-word;
        max-width: 100%;
    }

    .modal-header .close {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
    }

    .modal-img {
        height: 450px;
        width: 100%;
        object-fit: cover;
        border-radius: 0;
        user-select: none;
    }

    .noticia-img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 8px;
    }

    #btnPrevNoticia,
    #btnNextNoticia {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1050;
        background: rgba(0, 0, 0, 0.5);
        border: none;
        color: white;
        font-size: 2rem;
        padding: 0 12px;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
    }

    #btnPrevNoticia {
        left: 10px;
    }

    #btnNextNoticia {
        right: 10px;
    }
</style>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>CONDOSYNC</title>

    <!-- CSS -->
    <link href="css/media_query.css" rel="stylesheet" />
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="css/animate.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" />
    <link href="css/owl.carousel.css" rel="stylesheet" />
    <link href="css/owl.theme.default.css" rel="stylesheet" />
    <link href="css/style_1.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <script src="js/modernizr-3.5.0.min.js"></script>
</head>

<body>
    <div class="container-fluid fh5co_header_bg">
        <div class="container">
            <div class="row">
                <div class="col-12 fh5co_mediya_center">
                    <div class="d-flex align-items-center">
                        <img src="images/logo-sm.png" alt="Logo" style="height: 40px; margin-right: 10px;">
                        <a href="blog.html" class="treding_btn">CONDOSYNC</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid bg-faded fh5co_padd_mediya padding_786">
        <div class="container padding_786">
            <nav class="navbar navbar-expand-md navbar-light">
                <button class="navbar-toggler mt-3" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent">
                    <span class="fa fa-bars"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active"><a class="nav-link" href="blog.html">Home</a></li>
                        <li class="nav-item active"><a class="nav-link" href="eventos.html">Eventos</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <div class="container-fluid pb-4 pt-4 paddding">
        <div class="container paddding">
            <div class="row mx-0">
                <div class="col-md-8 animate-box" data-animate-effect="fadeInLeft">
                    <div class="fh5co_heading fh5co_heading_border_bottom py-2 mb-4">Notícias</div>

                    <!-- Carrossel de notícias -->
                    <div id="carousel-news" class="carousel slide" data-ride="carousel">
                        <ol class="carousel-indicators" id="carousel-indicators"></ol>
                        <div class="carousel-inner" id="carousel-inner"></div>
                        <a class="carousel-control-prev" href="#carousel-news" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Anterior</span>
                        </a>
                        <a class="carousel-control-next" href="#carousel-news" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Próximo</span>
                        </a>
                    </div>

                    <!-- Lista de outras notícias -->
                    <div id="noticias-list" class="mt-4"></div>
                </div>

                <div class="col-md-4 animate-box" data-animate-effect="fadeInRight">
                    <div class="fh5co_heading fh5co_heading_border_bottom py-2 mb-4">Eventos</div>
                    <div id="events-container" style="min-height: 400px; cursor: pointer;"
                        onclick="window.location.href='eventos.html'"></div>

                    <div style="margin-top:40px;">
                        <div class="fh5co_heading fh5co_heading_border_bottom py-2 mb-4">Enquetes</div>
                    </div>
                    <div id="polls-container" class="polls-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Notícia -->
    <div class="modal fade" id="noticiaModal" tabindex="-1" role="dialog" aria-labelledby="noticiaModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document" style="max-width:900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title mx-auto" id="noticiaModalLabel">Título da Notícia</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body position-relative" style="overflow-y: auto;">
                    <img id="modalImagem" src="" alt="" class="img-fluid modal-img w-100" />
                    <button id="btnPrevNoticia">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button id="btnNextNoticia">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                    <div class="p-3" style="position: relative; z-index: 1;">
                        <p id="modalConteudo"></p>
                        <p class="text-muted"><small id="modalAutorData"></small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="gototop js-top"><a href="#" class="js-gotop"><i class="fa fa-arrow-up"></i></a></div>

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script>
        const API_BASE = 'http://3.19.193.161/api';
        let noticiasData = [];
        let noticiaAtualIndex = -1;

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return isNaN(d) ? '' : d.toLocaleDateString('pt-BR');
        }

        async function abrirNoticia(id) {
            try {
                const index = noticiasData.findIndex(n => n.id === id);
                if (index === -1) throw new Error('Notícia não encontrada');
                noticiaAtualIndex = index;

                const noticia = noticiasData[index];

                document.getElementById('noticiaModalLabel').innerText = noticia.titulo || 'Sem título';
                document.getElementById('modalConteudo').innerHTML = noticia.conteudo || 'Sem conteúdo disponível.';
                document.getElementById('modalImagem').src = noticia.imagem || 'images/nathan-mcbride-229637.jpg';
                document.getElementById('modalAutorData').innerText = `Publicado em ${formatDate(noticia.data_publicacao)}`;

                const btnPrev = document.getElementById('btnPrevNoticia');
                const btnNext = document.getElementById('btnNextNoticia');
                btnPrev.style.display = noticiaAtualIndex > 0 ? 'inline-block' : 'none';
                btnNext.style.display = noticiaAtualIndex < noticiasData.length - 1 ? 'inline-block' : 'none';

                $('#noticiaModal').modal('show');
            } catch (err) {
                alert('Erro ao carregar a notícia completa.');
                console.error(err);
            }
        }


        async function loadNews() {
            try {
                const res = await fetch(`${API_BASE}/noticias?ativo=1`);
                if (!res.ok) throw new Error('Erro ao buscar notícias');
                const data = await res.json();

                data.sort((a, b) => new Date(b.data_publicacao) - new Date(a.data_publicacao));
                const importantes = data.slice(0, 3);
                noticiasData = data;

                const recentes = data.slice(0, 3);
                const outras = data.slice(3);

                const indicators = document.getElementById('carousel-indicators');
                const inner = document.getElementById('carousel-inner');
                indicators.innerHTML = '';
                inner.innerHTML = '';

                recentes.forEach((noticia, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const img = noticia.imagem || 'images/nathan-mcbride-229637.jpg';
                    const titulo = noticia.titulo || 'Sem título';
                    const resumo = noticia.resumo || (noticia.conteudo ? noticia.conteudo.slice(0, 100) + '...' : '');

                    indicators.innerHTML += `<li data-target="#carousel-news" data-slide-to="${index}" class="${isActive}"></li>`;
                    inner.innerHTML += `
                        <div class="carousel-item ${isActive}">
                            <img class="d-block w-100" style="height: 400px; object-fit: cover;" src="${img}" alt="${titulo}">
                            <div class="carousel-caption d-none d-md-block carousel-caption-blur">
                                <h5><a href="#" onclick="abrirNoticia(${noticia.id}); return false;" class="text-white">${titulo}</a></h5>
                                <p>${resumo}</p>
                            </div>
                        </div>`;
                });

                const noticiasList = document.getElementById('noticias-list');
                noticiasList.innerHTML = outras.map(noticia => {
                    const img = noticia.imagem || 'images/nathan-mcbride-229637.jpg';
                    const titulo = noticia.titulo || 'Sem título';
                    const resumo = noticia.resumo || (noticia.conteudo ? noticia.conteudo.slice(0, 120) + '...' : '');
                    const dataFormatada = formatDate(noticia.data);

                    return `
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <img src="${img}" alt="${titulo}" class="img-fluid noticia-img">
                            </div>
                            <div class="col-md-8">
                                <h5><a href="#" onclick="abrirNoticia(${noticia.id}); return false;">${titulo}</a></h5>
                                <p>${resumo}</p>
                                <p class="text-muted"><small>${dataFormatada}</small></p>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erro ao carregar notícias:', error);
            }
        }

        document.getElementById('btnPrevNoticia').addEventListener('click', () => {
            if (noticiaAtualIndex > 0) {
                abrirNoticia(noticiasData[noticiaAtualIndex - 1].id);
            }
        });

        document.getElementById('btnNextNoticia').addEventListener('click', () => {
            if (noticiaAtualIndex < noticiasData.length - 1) {
                abrirNoticia(noticiasData[noticiaAtualIndex + 1].id);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadNews();
        });

        async function loadCalendar() {
            try {
                const res = await fetch(`${API_BASE}/eventos?ativo=1`);
                if (!res.ok) throw new Error('Erro ao buscar eventos');
                const data = await res.json();

                const events = data.map(ev => ({
                    id: ev.id,
                    title: ev.titulo,
                    start: ev.data_evento,
                    description: ev.descricao || ''
                }));

                const calendarEl = document.getElementById('events-container');
                calendarEl.innerHTML = '';

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'pt-br',
                    headerToolbar: {
                        left: '',
                        center: 'title',
                        right: ''
                    },
                    events,
                    eventClick: function (info) {
                        alert(`Evento: ${info.event.title}\nDescrição: ${info.event.extendedProps.description || 'Sem descrição'}`);
                    }
                });

                calendar.render();
            } catch (error) {
                console.error('Erro ao carregar calendário:', error);
                document.getElementById('events-container').innerHTML =
                    '<p>Não foi possível carregar o calendário de eventos.</p>';

            }
        }
        async function loadPolls() {
            try {
                const res = await fetch(`${API_BASE}/enquetes?ativo=1`);
                if (!res.ok) throw new Error('Erro ao buscar enquetes');

                const data = await res.json();
                const container = document.getElementById('polls-container');
                container.innerHTML = '';

                function parseArray(input) {
                    if (Array.isArray(input)) return input;
                    if (typeof input === 'string') {
                        try {
                            const parsed = JSON.parse(input);
                            return Array.isArray(parsed) ? parsed : [];
                        } catch {
                            return [];
                        }
                    }
                    return [];
                }

                data.forEach((enquete) => {
                    const opcoes = parseArray(enquete.opcoes);
                    const enqueteId = `enquete_${enquete.id}`;
                    const localData = JSON.parse(localStorage.getItem(enqueteId) || null);

                    if (localData && localData.votou) {
                        const votos = localData.votos;
                        const totalVotos = votos.reduce((acc, val) => acc + val, 0);

                        const resultados = opcoes.map((opcao, i) => {
                            const v = votos[i] || 0;
                            const pct = totalVotos > 0 ? ((v / totalVotos) * 100).toFixed(1) : 0;
                            return `<p>${opcao}: ${v} voto${v !== 1 ? 's' : ''} (${pct}%)</p>`;
                        }).join('');

                        container.innerHTML += `
          <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
            <h5>${enquete.pergunta}</h5>
            ${resultados}
            <p><strong>Você já votou nesta enquete.</strong></p>
          </div>
        `;
                    } else {
                        const opcoesHtml = opcoes.map((opcao, i) => `
          <div>
            <input type="radio" name="${enqueteId}" id="${enqueteId}_${i}" value="${i}">
            <label for="${enqueteId}_${i}">${opcao}</label>
          </div>
        `).join('');

                        container.innerHTML += `
          <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
            <h5>${enquete.pergunta}</h5>
            <form id="form_${enqueteId}">
              ${opcoesHtml}
              <button type="submit">Votar</button>
            </form>
          </div>
        `;

                        // Listener do form
                        setTimeout(() => {
                            const form = document.getElementById(`form_${enqueteId}`);
                            form.addEventListener('submit', (e) => {
                                e.preventDefault();
                                const selected = form.querySelector('input[name="' + enqueteId + '"]:checked');
                                if (!selected) return alert("Selecione uma opção.");

                                const index = parseInt(selected.value);
                                let votos = new Array(opcoes.length).fill(0);
                                votos[index] = 1;

                                // Salva no localStorage
                                localStorage.setItem(enqueteId, JSON.stringify({
                                    votou: true,
                                    votos: votos
                                }));

                                alert("Voto registrado localmente!");
                                loadPolls(); // Atualiza a exibição
                            });
                        }, 0);
                    }
                });

            } catch (error) {
                console.error('Erro ao carregar enquetes:', error);
                document.getElementById('polls-container').innerHTML =
                    '<p>Não foi possível carregar as enquetes.</p>';
            }
        }



        document.addEventListener('DOMContentLoaded', () => {
            loadNews();
            loadCalendar();
            loadPolls();
        });
    </script>
</body>

</html>