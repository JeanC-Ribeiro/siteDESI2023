<!DOCTYPE html>
<html lang="en" class="no-js">

<style>
    .carousel-caption-blur {
        background: rgba(0, 0, 0, 0.4);
        /* Fundo preto semi-transparente */
        backdrop-filter: blur(8px);
        /* Desfoque */
        -webkit-backdrop-filter: blur(8px);
        /* Suporte Safari */
        border-radius: 10px;
        padding: 1rem;
    }
</style>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>CONDOSYNC</title>

    <!-- CSS -->
    <link href="css/media_query.css" rel="stylesheet" />
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="css/animate.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" />
    <link href="css/owl.carousel.css" rel="stylesheet" />
    <link href="css/owl.theme.default.css" rel="stylesheet" />
    <link href="css/style_1.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <script src="js/modernizr-3.5.0.min.js"></script>
</head>

<body>
    <div class="container-fluid fh5co_header_bg">
        <div class="container">
            <div class="row">
                <div class="col-12 fh5co_mediya_center">
                    <div class="d-flex align-items-center">
                        <img src="images/logo-sm.png" alt="Logo" style="height: 40px; margin-right: 10px;">
                        <a href="#" class="treding_btn">CONDOSYNC</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid bg-faded fh5co_padd_mediya padding_786">
        <div class="container padding_786">
            <nav class="navbar navbar-expand-md navbar-light">
                <button class="navbar-toggler mt-3" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent">
                    <span class="fa fa-bars"></span>
                </button>
                <a class="navbar-brand" href="#"><img src="images/logo-sm.png.png" class="mobile_logo_width" /></a>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active"><a class="nav-link" href="blog.html">Home</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <div class="container-fluid pb-4 pt-4 paddding">
        <div class="container paddding">
            <div class="row mx-0">
                <div class="col-md-8 animate-box" data-animate-effect="fadeInLeft">
                    <div class="fh5co_heading fh5co_heading_border_bottom py-2 mb-4">Notícias</div>

                    <!-- Carrossel de notícias -->
                    <div id="carousel-news" class="carousel slide" data-ride="carousel">
                        <ol class="carousel-indicators" id="carousel-indicators"></ol>
                        <div class="carousel-inner" id="carousel-inner"></div>
                        <a class="carousel-control-prev" href="#carousel-news" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Anterior</span>
                        </a>
                        <a class="carousel-control-next" href="#carousel-news" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Próximo</span>
                        </a>
                    </div>
                </div>

                <div class="col-md-4 animate-box" data-animate-effect="fadeInRight">
                    <div class="fh5co_heading fh5co_heading_border_bottom py-2 mb-4">Eventos</div>
                    <div id="events-container" style="min-height: 400px;"></div>

                    <div style="margin-top:40px;">
                        <div class="fh5co_heading fh5co_heading_border_bottom py-2 mb-4">Enquetes</div>
                    </div>
                    <div id="polls-container" class="polls-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="gototop js-top"><a href="#" class="js-gotop"><i class="fa fa-arrow-up"></i></a></div>

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script>
        const API_BASE = 'http://3.19.193.161/api';

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return isNaN(d) ? '' : d.toLocaleDateString('pt-BR');
        }

        async function loadNews() {
            try {
                const res = await fetch(`${API_BASE}/noticias?ativo=1`);
                if (!res.ok) throw new Error('Erro ao buscar notícias');
                const data = await res.json();

                const indicators = document.getElementById('carousel-indicators');
                const inner = document.getElementById('carousel-inner');
                indicators.innerHTML = '';
                inner.innerHTML = '';

                data.forEach((noticia, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const img = noticia.imagem || 'images/nathan-mcbride-229637.jpg';
                    const titulo = noticia.titulo || 'Sem título';
                    const resumo = noticia.resumo || (noticia.conteudo ? noticia.conteudo.slice(0, 100) + '...' : '');
                    const autor = noticia.autor || 'Autor';
                    const dataFormatada = formatDate(noticia.data);

                    indicators.innerHTML += `<li data-target="#carousel-news" data-slide-to="${index}" class="${isActive}"></li>`;
                    inner.innerHTML += `
            <div class="carousel-item ${isActive}">
                <img class="d-block w-100" style="height: 400px; object-fit: cover;" src="${img}" alt="${titulo}">
                <div class="carousel-caption d-none d-md-block carousel-caption-blur">
                    <h5><a href="single.html?id=${noticia.id}" class="text-white">${titulo}</a></h5>
                    <p>${resumo}</p>
                    <small>${autor} - ${dataFormatada}</small>
                </div>
            </div>`;
                });

            } catch (error) {
                console.error('Erro ao carregar notícias:', error);
                document.getElementById('carousel-inner').innerHTML =
                    '<div class="carousel-item active"><p class="text-center">Erro ao carregar notícias.</p></div>';
            }
        }


        async function loadCalendar() {
            try {
                const res = await fetch(`${API_BASE}/eventos?ativo=1`);
                if (!res.ok) throw new Error('Erro ao buscar eventos');
                const data = await res.json();

                const events = data.map(ev => ({
                    id: ev.id,
                    title: ev.titulo,
                    start: ev.data_evento,
                    description: ev.descricao || ''
                }));

                const calendarEl = document.getElementById('events-container');
                calendarEl.innerHTML = '';

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'pt-br',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events,
                    eventClick: function (info) {
                        alert(`Evento: ${info.event.title}\nDescrição: ${info.event.extendedProps.description || 'Sem descrição'}`);
                    }
                });

                calendar.render();
            } catch (error) {
                console.error('Erro ao carregar calendário:', error);
                document.getElementById('events-container').innerHTML =
                    '<p>Não foi possível carregar o calendário de eventos.</p>';
            }
        }

        async function loadPolls() {
            try {
                const res = await fetch(`${API_BASE}/enquetes?ativo=1`);
                if (!res.ok) throw new Error('Erro ao buscar enquetes');

                const data = await res.json();
                console.log('Resposta da API (enquetes):', data);

                const container = document.getElementById('polls-container');
                container.innerHTML = '';

                function parseArray(input) {
                    if (Array.isArray(input)) return input;
                    if (typeof input === 'string') {
                        try {
                            const parsed = JSON.parse(input);
                            return Array.isArray(parsed) ? parsed : [];
                        } catch {
                            return [];
                        }
                    }
                    return [];
                }

                data.forEach((enquete, index) => {
                    const opcoes = parseArray(enquete.opcoes);
                    const votos = parseArray(enquete.votos);

                    const enqueteId = enquete.id;
                    const pergunta = enquete.pergunta;

                    const opcoesHtml = opcoes.map((opcao, i) => `
                <div>
                    <input type="radio" name="enquete_${enqueteId}" id="opcao_${enqueteId}_${i}" value="${i}">
                    <label for="opcao_${enqueteId}_${i}">${opcao}</label>
                </div>
            `).join('');

                    container.innerHTML += `
                <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
                    <h5>${pergunta}</h5>
                    <form id="form_enquete_${enqueteId}">
                        ${opcoesHtml}
                        <button type="submit">Votar</button>
                    </form>
                </div>
            `;

                    // Adiciona o listener do form
                    setTimeout(() => {
                        const form = document.getElementById(`form_enquete_${enqueteId}`);
                        if (form) {
                            form.addEventListener('submit', async (e) => {
                                e.preventDefault();

                                const selected = form.querySelector('input[name="enquete_' + enqueteId + '"]:checked');
                                if (!selected) return alert("Por favor, selecione uma opção.");

                                const opcaoIndex = parseInt(selected.value);

                                // Atualiza os votos
                                let votosAtualizados = [...(Array.isArray(votos) ? votos : [])];
                                while (votosAtualizados.length < opcoes.length) votosAtualizados.push(0);
                                votosAtualizados[opcaoIndex] += 1;

                                try {
                                    const updateRes = await fetch(`${API_BASE}/enquetes/${enqueteId}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ votos: JSON.stringify(votosAtualizados) })
                                    });

                                    if (!updateRes.ok) throw new Error("Erro ao registrar voto");

                                    alert("Voto registrado com sucesso!");
                                    loadPolls(); // recarrega os resultados
                                } catch (err) {
                                    console.error("Erro ao votar:", err);
                                    alert("Erro ao registrar voto.");
                                }
                            });
                        }
                    }, 0);
                });
            } catch (error) {
                console.error('Erro ao carregar enquetes:', error);
                document.getElementById('polls-container').innerHTML =
                    '<p>Não foi possível carregar as enquetes.</p>';
            }
        }



        document.addEventListener('DOMContentLoaded', () => {
            loadNews();
            loadCalendar();
            loadPolls();
        });
    </script>
</body>

</html>